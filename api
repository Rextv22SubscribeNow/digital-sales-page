export default async function handler(req, res) {
  const { orderID } = req.query;

  if (!orderID) {
    res.status(400).send('Missing orderID.');
    return;
  }

  // --- PayPal Live Credentials ---
  const clientId = 'AYwnqKQANTptydubBPhcZc_Tq_a1T0zpNgb4YCJZcBr2E1nseI7HQUjI2Obq3wvp471DBbNUFgILjpaK';
  const secret = 'ELhUZgmJMKv7uwmP94F3LjvJsgU_FMDvWOy-eOxpF-11J4fXsQNCrzNxIstRerCQeXp_coZVFoK1TL-6';
  const base64 = Buffer.from(clientId + ':' + secret).toString('base64');

  try {
    // Step 1: Get access token from PayPal
    const tokenResponse = await fetch('https://api-m.paypal.com/v1/oauth2/token', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${base64}`,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'grant_type=client_credentials'
    });
    const tokenData = await tokenResponse.json();
    const accessToken = tokenData.access_token;

    // Step 2: Verify the order
    const orderResponse = await fetch(`https://api-m.paypal.com/v2/checkout/orders/${orderID}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    });
    const orderData = await orderResponse.json();

    // Step 3: Check payment status
    if (orderData.status === 'COMPLETED') {
      // Payment verified â†’ redirect to Google Drive secure download
      res.writeHead(302, { Location: 'https://drive.google.com/uc?export=download&id=1xUU66tnymfCyy11buwcCtdyZGfQJHBpL' });
      res.end();
    } else {
      res.status(403).send('Payment not completed or invalid order.');
    }

  } catch (error) {
    console.error('PayPal API error:', error);
    res.status(500).send('Server error verifying payment.');
  }
}
